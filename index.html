<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>QTLs - Rodriguez Lab</title>
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  
  <body>
    <main>
        <h1><a href="https://oscarlr.github.io/">Rodriguez Lab</a>'s QTLs</h1>  
        Check out the <a href="https://github.com/a-pinch-ofsalt/qtl-site">GitHub repository</a> to add data!</p>
    </main>
    

    <label for="snpInput">SNP ID</label>
    <input id="snpInput" list="snp-list" placeholder="1027214">
    <datalist id="snp-list"></datalist>

    <label for="geneInput">Gene</label>
    <input id="geneInput" list="gene-list" placeholder="IGHV3-64">
    <datalist id="gene-list"></datalist>

    <button id="searchButton">Search</button>
    <button id="clearPlots" style="margin-top:1em;">Clear Plots</button>
    <div id="plots" style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      grid-gap: 1em;
      margin-top: 1em;
    "></div>
    
    <section id="accordions" style="margin-top:1em;">

      <details>
        <summary>M_all_rank</summary>
        <div class="manhattan-holder"></div>
        <div class="table-panel" data-table="M_all_rank"></div>
      </details>
  
      <details>
        <summary>G_all_rank</summary>
        <div class="manhattan-holder"></div>
        <div class="table-panel" data-table="G_all_rank"></div>
      </details>
  
      <details>
        <summary>final_qtls_noIGKV1-13DEL</summary>
        <div class="manhattan-holder"></div>
        <div class="table-panel" data-table="final_qtls_noIGKV1-13DEL"></div>
      </details>

      <details>
        <summary>K_L_guQTL_cleaned</summary>
        <div class="manhattan-holder"></div>
        <div class="table-panel" data-table="K_L_guQTL_cleaned"></div>
      </details>
  
    </section>

  </body>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <div id="result-table"></div>


<!-- 2) Somewhere in your HTML, reserve a div for the chart -->


<!-- Include Plotly first -->
<script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

<!-- Your main module script -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient('https://mwfhieyoqukgntpefijn.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13ZmhpZXlvcXVrZ250cGVmaWpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzOTU4NDUsImV4cCI6MjA2ODk3MTg0NX0.0ZLQjjO1AWibBhWZdueGmgbRv8QF_r7uyRmMExf2_tY');

  

  let plotCount = 0;
  const plotsContainer = document.getElementById('plots');
  document.getElementById('clearPlots').addEventListener('click', () => {
    plotsContainer.innerHTML = '';
    plotCount = 0;
  });

  // Call this once at startup:
  setupAutocomplete('geneInput', 'gene-list', 'gene');
  setupAutocomplete('snpInput',  'snp-list',  'variant');

  function setupAutocomplete(inputId, listId, column) {
    const inp   = document.getElementById(inputId);
    const dataL = document.getElementById(listId);

    let lastTerm = '';
    inp.addEventListener('input', async e => {
      const term = e.target.value.trim();
      if (term === lastTerm || term.length < 1) return;
      lastTerm = term;

      // clear old options
      dataL.innerHTML = '';

      // search _all_ four tables for distinct matches
      const tables = ['M_all_rank','G_all_rank','final_qtls_noIGKV1-13DEL','K_L_guQTL_cleaned'];
      const seen   = new Set();

      await Promise.all(tables.map(async tbl => {
        const { data, error } = await supabase
          .from(tbl)
          .select(column)
          .ilike(column, `%${term}%`)
          .limit(10);              // keep it snappy

        if (data) {
          data.forEach(r => {
            const val = r[column];
            if (val && !seen.has(val)) {
              seen.add(val);
              const opt = document.createElement('option');
              opt.value = val;
              dataL.appendChild(opt);
            }
          });
        }
      }));
    });
  }


  document.getElementById("searchButton")
    .addEventListener("click", onSearch);
  async function onSearch() {
    const snp    = document.getElementById("snpInput").value;
    const gene   = document.getElementById("geneInput").value;
    const panels = document.querySelectorAll('.table-panel');

    for (let panel of panels) {
      const tableName = panel.dataset.table;
      let query = supabase.from(tableName).select('*');
      if (snp)  query = query.eq('variant', snp);
      if (gene) query = query.eq('gene', gene);

      const { data, error } = await query;
      // clear old
      panel.innerHTML = '';
      const manHolder = panel.previousElementSibling;
      manHolder.innerHTML = '';

      if (error) {
        panel.innerText = `Error: ${error.message}`;
      }
      else if (!data.length) {
        panel.innerText = 'No results found.';
      }
      else {
        // CSV link + table
        const headers = Object.keys(data[0]);
        const rows = [
          headers.join(','),
          ...data.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))
        ];
        const blob   = new Blob([ rows.join('\n') ], { type: 'text/csv' });
        const url    = URL.createObjectURL(blob);
        const dl     = document.createElement('a');
        dl.href      = url;
        dl.download  = `${tableName}.csv`;
        dl.innerText = 'Download CSV';
        dl.style.display   = 'inline-block';
        dl.style.marginTop = '0.5em';

        const tableEl = buildTable(data);
        panel.appendChild(dl);
        panel.appendChild(tableEl);

        // Manhattan
        if (gene) {
          await plotPanelManhattan(tableName, gene, manHolder);
        } else if (snp) {
          await plotPanelBySnp(tableName, snp, manHolder);
        }




        // auto‑open the detail so you can see it
        panel.parentElement.open = true;
      }
    }

  }

  // helper to draw into the holder div:
  async function plotPanelManhattan(tableName, gene, holderDiv) {
    // pull out exactly this table’s variants + pvalues
    const { data, error } = await supabase
      .from(tableName)
      .select('variant, pvalue')
      .eq('gene', gene);

    if (error || !data.length) return;

    // make a new div in the holder
    const id = `man-${tableName}-${plotCount++}`;
    const plotDiv = document.createElement('div');
    plotDiv.id = id;
    plotDiv.style = 'width:100%; height:250px; margin-bottom:0.5em;';
    holderDiv.appendChild(plotDiv);

    // bar‑style Manhattan
    const x = data.map(d => d.variant);
    const y = data.map(d => -Math.log10(d.pvalue));
    Plotly.newPlot(id, [{
      x, y, type: 'bar', marker:{ line:{ width:1 }}
    }], {
      title: `–log₁₀(p) in ${tableName}`,
      xaxis:{type:'category', tickangle:-45, title:'Variant'},
      yaxis:{ title:'–log₁₀(p)' },
      margin:{ t:30, b:80, l:50, r:20 }
    });
  }

    // … after plotPanelManhattan …

  // for SNP searches: x = genes, y = –log10(p)
  async function plotPanelBySnp(tableName, snp, holderDiv) {
    const { data, error } = await supabase
      .from(tableName)
      .select('gene, pvalue')
      .eq('variant', snp);

    if (error || !data.length) return;

    // sort genes alphanumerically:
    const genes = data
      .map(d => d.gene)
      .sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));

    // map p‑values in the same order:
    const y = genes.map(g => {
      const row = data.find(d => d.gene === g);
      return -Math.log10(row.pvalue);
    });

    const id = `man-snp-${tableName}-${plotCount++}`;
    const plotDiv = document.createElement('div');
    plotDiv.id = id;
    plotDiv.style = 'width:100%; height:250px; margin-bottom:0.5em;';
    holderDiv.appendChild(plotDiv);

    Plotly.newPlot(id, [{
      x: genes,
      y: y,
      type: 'bar',
      marker: { line: { width: 1 } }
    }], {
      title: `–log₁₀(p) in ${tableName} for SNP ${snp}`,
      xaxis: {
        type: 'category',
        categoryorder: 'array',
        categoryarray: genes,
        tickangle: -45,
        title: 'Gene'
      },
      yaxis: { title: '–log₁₀(p‑value)' },
      margin: { t: 30, b: 80, l: 50, r: 20 }
    });
  }



    // generic table builder, returns a <table> element
  function buildTable(rows) {
    const table = document.createElement('table');
    table.border = 1;
    const header = table.insertRow();
    Object.keys(rows[0]).forEach(key => {
      const th = document.createElement('th');
      th.innerText = key;
      header.appendChild(th);
    });

    rows.forEach(row => {
      const tr = table.insertRow();
      Object.entries(row).forEach(([key, val]) => {
        const td = tr.insertCell();
        td.innerText = val;
        if (key === 'variant') {
          td.style.cursor = 'pointer';
          td.style.textDecoration = 'underline';
          td.addEventListener('click', () => showQtlPlot(row.variant, row.gene));
        }
      });
    });
    return table;
  }


  async function showQtlPlot(variant, gene) {
    console.log(variant, gene)
    // fetch SNP row
    const { data: snpRow, error: e1 } = await supabase
      .from('qtl_data')
      .select('*')
      .eq('feature', variant)
      .eq('type', 'snp')
      .single();
    if (e1) return console.error(e1);

    // fetch Gene row
    const { data: geneRow, error: e2 } = await supabase
      .from('qtl_data')
      .select('*')
      .eq('feature', gene)
      .eq('type', 'gene')
      .single();
    if (e2) return console.error(e2);
    console.log(snpRow)
    console.log(geneRow)

    // identify sample columns
    const samples = Object.keys(snpRow).filter(k => !['feature','type'].includes(k));
    
    // group gene expression by genotype
    const byGenotype = {};
    samples.forEach(s => {
      const g    = snpRow[s];
      const expr = geneRow[s];
      (byGenotype[g] = byGenotype[g] || []).push(expr);
    });
    console.log(samples)
    // build traces
    const traces = Object.entries(byGenotype)
      .sort((a,b) => a[0] - b[0])
      .map(([geno, vals]) => ({
        y: vals,
        name: `Genotype ${geno}`,
        type: 'box'
      }));
    console.log(traces)
    const plotId = `boxplot-${plotCount++}`;
    const wrapper = document.createElement('div');
    wrapper.id = plotId;
    wrapper.style = 'width:100%; height:300px;';  // height can be fixed
    plotsContainer.appendChild(wrapper);

    // plot into it
    Plotly.newPlot(plotId, traces, {
      title: `${gene} expression by ${variant} genotype`,
      xaxis: { title: 'Genotype' },
      yaxis: { title: 'Expression' },
      margin: { t:40, l:50, r:20, b:40 }
    });

  }

  async function showManhattanPlot(gene) {
    // grab variant and pvalue for every snp hitting this gene
    const { data, error } = await supabase
      .from('M_all_rank')
      .select('variant, pvalue')
      .eq('gene', gene);

    if (error) return console.error(error);

    // build arrays
    const x = data.map(d => d.variant);
    const y = data.map(d => -Math.log10(d.pvalue));

    // pick a new div in the grid
    const idx = plotCount++;
    const id  = `manhattan-${idx}`;
    const wrapper = document.createElement('div');
    wrapper.id = id;
    wrapper.style = 'width:100%; height:300px;';
    plotsContainer.appendChild(wrapper);

    // render as a bar plot with categorical x-axis
    Plotly.newPlot(id, [{
      x,
      y,
      type: 'bar',
      marker: { line: { width: 1 } }
    }], {
      title: `–log₁₀(p‑value) for ${gene}`,
      xaxis: {
        title: 'Variant',
        type: 'category',
        tickangle: -45
      },
      yaxis: { title: '-log₁₀(p‑value)' },
      margin: { t: 40, l: 50, r: 20, b: 80 }
    });
  }


</script>



  

</html>